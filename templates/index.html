<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Voice Email Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      /* Base (ChatGPT-ish) */
      --bg: #0b0f17;
      --panel: #121826;
      --panel2:#0f1522;
      --text: #e7eaf0;
      --muted: rgba(231,234,240,.75);
      --border: rgba(255,255,255,.10);
      --accent: #10a37f;
      --accent2:#2ee59d;
      --user: #1f6feb;
      --assistant: rgba(255,255,255,.06);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }

    /* ===== THEMES ===== */
    body.theme-siri{
      --bg:#070a14;
      --panel: rgba(255,255,255,.07);
      --panel2: rgba(255,255,255,.05);
      --accent:#7c3aed;
      --accent2:#22d3ee;
      --user:#2563eb;
      --assistant: rgba(255,255,255,.08);
    }
    body.theme-hacker{
      --bg:#020604;
      --panel:#05130b;
      --panel2:#041009;
      --text:#b9ffcc;
      --muted: rgba(185,255,204,.7);
      --border: rgba(57,255,124,.18);
      --accent:#39ff7c;
      --accent2:#00ffa2;
      --user:#00c853;
      --assistant: rgba(57,255,124,.06);
      --shadow: 0 18px 60px rgba(0,255,120,.10);
    }
    body.theme-saas{
      --bg:#0b1220;
      --panel:#0f1b2d;
      --panel2:#0c1626;
      --accent:#3b82f6;
      --accent2:#22c55e;
      --user:#2563eb;
      --assistant: rgba(255,255,255,.06);
    }
    body.theme-glass{
      --bg: radial-gradient(1200px 800px at 20% 0%, rgba(46,229,157,.20), transparent 55%),
            radial-gradient(1000px 700px at 80% 10%, rgba(34,211,238,.20), transparent 55%),
            linear-gradient(135deg, #08121f, #07101b);
      --panel: rgba(255,255,255,.08);
      --panel2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.16);
      --accent:#2ee59d;
      --accent2:#22d3ee;
      --assistant: rgba(255,255,255,.10);
      --shadow: 0 18px 70px rgba(0,0,0,.50);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display:flex;
      justify-content:center;
      align-items:center;
      padding: 18px;
    }

    .app{
      width: min(980px, 100%);
      height: min(86vh, 820px);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction: column;
      backdrop-filter: blur(10px);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 16px;
      background: var(--panel2);
      border-bottom: 1px solid var(--border);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .brand .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 18px rgba(16,163,127,.55);
    }
    .brand small{
      display:block;
      font-weight:500;
      color: var(--muted);
      letter-spacing: 0;
      margin-top:2px;
    }

    .controls{
      display:flex;
      align-items:center;
      gap: 10px;
    }

    select{
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px 10px;
      outline: none;
    }
    option{ color:#111; }

    .chat{
      flex:1;
      overflow:auto;
      padding: 18px;
      scroll-behavior: smooth;
    }

    .msgRow{
      display:flex;
      margin: 10px 0;
    }
    .msg{
      max-width: 76%;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--assistant);
      line-height: 1.45;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .msg.user{
      margin-left:auto;
      background: rgba(31,111,235,.20);
      border-color: rgba(31,111,235,.35);
    }
    .msg.assistant{
      margin-right:auto;
    }

    .meta{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    .chips{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .chip{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{
      border-color: rgba(255,255,255,.22);
    }

    .composer{
      border-top: 1px solid var(--border);
      background: var(--panel2);
      padding: 12px 14px;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      margin-left: 4px;
    }

    .speakBtn{
      border: none;
      cursor:pointer;
      padding: 10px 14px;
      border-radius: 12px;
      color: #061018;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      font-weight: 700;
      display:flex;
      align-items:center;
      gap: 8px;
      transition: transform .15s ease, filter .15s ease;
    }
    .speakBtn:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    .speakBtn.recording{
      animation: pulse 1.1s infinite;
    }
    @keyframes pulse{
      0%{ box-shadow: 0 0 0 0 rgba(46,229,157,.35); }
      70%{ box-shadow: 0 0 0 14px rgba(46,229,157,0); }
      100%{ box-shadow: 0 0 0 0 rgba(46,229,157,0); }
    }

    .typing{
      display:inline-flex;
      gap: 6px;
      align-items:center;
      font-size: 13px;
      color: var(--muted);
    }
    .dot{
      width:6px;height:6px;border-radius:50%;
      background: var(--muted);
      animation: bounce 1.1s infinite;
    }
    .dot:nth-child(2){ animation-delay: .15s; }
    .dot:nth-child(3){ animation-delay: .30s; }
    @keyframes bounce{
      0%, 80%, 100%{ transform: translateY(0); opacity:.7; }
      40%{ transform: translateY(-4px); opacity:1; }
    }

    .emailCard{
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      margin-top: 10px;
      background: rgba(0,0,0,.12);
    }
    .emailCard .title{
      font-weight: 800;
      color: var(--accent2);
      margin-bottom: 6px;
    }
    .emailCard .row{
      margin: 2px 0;
      color: var(--text);
    }
    .emailCard .label{
      color: var(--muted);
    }
  </style>
</head>

<body class="theme-glass">
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <div>
          Voice Email Assistant
          <small>Voice ‚Üí Intent ‚Üí Gmail</small>
        </div>
      </div>

      <div class="controls">
        <select id="themeSel" title="Theme">
          <option value="theme-glass">Futuristic Glass</option>
          <option value="theme-chatgpt">ChatGPT</option>
          <option value="theme-siri">Siri / AI</option>
          <option value="theme-hacker">Cyber Hacker</option>
          <option value="theme-saas">SaaS Dashboard</option>
        </select>
      </div>
    </div>

    <div class="chat" id="chat"></div>

    <div class="composer">
      <button class="speakBtn" id="speakBtn" onclick="startRecording()">üé§ Speak</button>
      <div class="hint">Try: ‚ÄúRead my inbox‚Äù, ‚ÄúNext email‚Äù, ‚ÄúPrevious email‚Äù</div>
    </div>
  </div>

<script>
const chat = document.getElementById("chat");
const speakBtn = document.getElementById("speakBtn");
const themeSel = document.getElementById("themeSel");

let recognition = null;
let isRecording = false;
let isProcessing = false;

let lastFinalText = "";
let lastFinalAt = 0;

/* =========================
   THEME FIX (was missing)
========================= */
themeSel.addEventListener("change", () => {
  document.body.className = themeSel.value;
});

/* =========================
   MESSAGE HELPERS
========================= */
function addMsg(role, text, html=false) {
  const row = document.createElement("div");
  row.className = "msgRow";

  const bubble = document.createElement("div");
  bubble.className = "msg " + (role === "user" ? "user" : "assistant");

  if (html) bubble.innerHTML = text;
  else bubble.textContent = text;

  row.appendChild(bubble);
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;

  return bubble;
}

function addTyping() {
  const bubble = addMsg("assistant", "", true);
  bubble.innerHTML =
    `<span class="typing">
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
     </span>`;
  return bubble;
}

addMsg("assistant", `Hi Jeevan üëã
Say: "Read my inbox"`);

/* =========================
   SPEECH
========================= */
function startRecording() {
  if (isRecording || isProcessing) return;

  if (!('webkitSpeechRecognition' in window)) {
    addMsg("assistant", "Speech recognition not supported.");
    return;
  }

  if (recognition) {
    try { recognition.abort(); } catch(e) {}
    recognition = null;
  }

  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = false;
  recognition.interimResults = true;

  isRecording = true;
  speakBtn.classList.add("recording");
  recognition.start();

  recognition.onresult = async (event) => {
    let finalText = "";

    for (let i = event.resultIndex; i < event.results.length; i++) {
      if (event.results[i].isFinal) {
        finalText += event.results[i][0].transcript;
      }
    }

    finalText = finalText.trim();
    if (!finalText) return;
    if (isProcessing) return;

    const now = Date.now();
    const norm = finalText.toLowerCase();
    if (norm === lastFinalText && (now - lastFinalAt) < 2000) return;

    lastFinalText = norm;
    lastFinalAt = now;

    try { recognition.stop(); } catch(e) {}
    recognition = null;

    isRecording = false;
    speakBtn.classList.remove("recording");

    addMsg("user", finalText);

    isProcessing = true;
    try {
      await processText(finalText);
    } finally {
      isProcessing = false;
    }
  };

  recognition.onend = () => {
    isRecording = false;
    speakBtn.classList.remove("recording");
  };

  recognition.onerror = () => {
    isRecording = false;
    speakBtn.classList.remove("recording");
    addMsg("assistant", "‚ùå Speech recognition error.");
  };
}

/* =========================
   DEFENSIVE FETCH
========================= */
async function safeJson(response) {
  try {
    return await response.json();
  } catch (e) {
    const raw = await response.text();
    console.error("Invalid JSON response:", raw);
    return { error: "SERVER_RETURNED_INVALID_JSON" };
  }
}

/* =========================
   PROCESS PIPELINE
========================= */
async function processText(text) {
  const typing = addTyping();

  try {
    const intentRes = await fetch("/api/intent", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text })
    });

    const intent = await safeJson(intentRes);

    const actionRes = await fetch("/api/action", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(intent)
    });

    const result = await safeJson(actionRes);

    typing.remove();

    if (result.error === "AUTH_REQUIRED") {
      addMsg("assistant", "üîê Redirecting to Google login...");
      if (result.auth_url) window.location.href = result.auth_url;
      return;
    }

    if (result.emails) {
      let html = `<div style="font-weight:800">üì¨ Inbox</div>`;

      result.emails.forEach((email, i) => {
        html += `
          <div class="emailCard">
            <div class="title">Email ${i+1}</div>
            <div class="row"><b>From:</b> ${escapeHtml(email.sender || "")}</div>
            <div class="row"><b>Subject:</b> ${escapeHtml(email.subject || "")}</div>
            <div class="row"><b>Preview:</b> ${escapeHtml(email.snippet || "")}</div>
          </div>`;
      });

      addMsg("assistant", html, true);
      return;
    }

    if (result.email) {
      const email = result.email;
      addMsg("assistant",
`From: ${email.sender}
Subject: ${email.subject}
Preview: ${email.snippet}`);
      return;
    }

    if (result.error) {
      addMsg("assistant", "‚ùå " + (result.message || result.error));
      return;
    }

    addMsg("assistant", JSON.stringify(result, null, 2));

  } catch (e) {
    typing.remove();
    addMsg("assistant", "‚ùå Unexpected error.");
    console.error(e);
  }
}

/* =========================
   XSS SAFE
========================= */
function escapeHtml(str) {
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
</script>
</body>
</html>
