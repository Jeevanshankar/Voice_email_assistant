<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Voice Email Assistant</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root{
  --bg:#0b0f17;
  --panel:#121826;
  --panel2:#0f1522;
  --text:#e7eaf0;
  --muted:rgba(231,234,240,.75);
  --border:rgba(255,255,255,.10);
  --accent:#10a37f;
  --accent2:#2ee59d;
  --assistant:rgba(255,255,255,.06);
  --shadow:0 18px 60px rgba(0,0,0,.45);
  --radius:16px;
}

body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui;display:flex;justify-content:center;align-items:center;height:100vh}
.app{width:95%;max-width:980px;height:90vh;background:var(--panel);border-radius:var(--radius);display:flex;flex-direction:column;overflow:hidden}
.topbar{padding:12px 16px;background:var(--panel2);display:flex;justify-content:space-between;align-items:center}
.chat{flex:1;overflow:auto;padding:16px}
.msgRow{display:flex;margin:8px 0}
.msg{max-width:75%;padding:10px 14px;border-radius:14px;background:var(--assistant);white-space:pre-wrap}
.msg.user{margin-left:auto;background:#1f6feb33}
.composer{padding:12px;background:var(--panel2);display:flex;gap:10px;align-items:center}
.speakBtn{padding:10px 16px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));font-weight:bold;cursor:pointer}
.emailCard{margin-top:10px;padding:10px;border:1px solid var(--border);border-radius:12px}
.emailCard .title{font-weight:bold;color:var(--accent2)}
.typing{opacity:.7;font-size:13px}
</style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div><b>Voice Email Assistant</b></div>
    <select id="themeSel">
      <option value="theme-glass">Glass</option>
      <option value="theme-siri">Siri</option>
      <option value="theme-hacker">Hacker</option>
      <option value="theme-saas">SaaS</option>
    </select>
  </div>

  <div class="chat" id="chat"></div>

  <div class="composer">
    <button class="speakBtn" id="speakBtn">üé§ Speak</button>
    <div class="typing">Try: ‚ÄúRead my inbox‚Äù</div>
  </div>
</div>

<script>
const chat = document.getElementById("chat");
const speakBtn = document.getElementById("speakBtn");

let recognition=null;
let isRecording=false;
let isProcessing=false;
let lastFinalText="";
let lastFinalAt=0;

function addMsg(role,text,html=false){
  const row=document.createElement("div");
  row.className="msgRow";
  const bubble=document.createElement("div");
  bubble.className="msg "+(role==="user"?"user":"assistant");
  if(html) bubble.innerHTML=text;
  else bubble.textContent=text;
  row.appendChild(bubble);
  chat.appendChild(row);
  chat.scrollTop=chat.scrollHeight;
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

addMsg("assistant","Hi Jeevan üëã\nSay: Read my inbox");

speakBtn.onclick=()=>startRecording();

function startRecording(){
  if(isRecording||isProcessing)return;
  if(!('webkitSpeechRecognition'in window)){
    addMsg("assistant","Speech recognition not supported.");
    return;
  }

  recognition=new webkitSpeechRecognition();
  recognition.lang="en-US";
  recognition.interimResults=true;
  recognition.continuous=false;

  isRecording=true;
  recognition.start();

  recognition.onresult=async(event)=>{
    let finalText="";
    for(let i=event.resultIndex;i<event.results.length;i++){
      if(event.results[i].isFinal){
        finalText+=event.results[i][0].transcript;
      }
    }
    finalText=finalText.trim();
    if(!finalText)return;

    const now=Date.now();
    if(finalText.toLowerCase()===lastFinalText && now-lastFinalAt<2000)return;
    lastFinalText=finalText.toLowerCase();
    lastFinalAt=now;

    recognition.stop();
    isRecording=false;

    addMsg("user",finalText);

    isProcessing=true;
    await processText(finalText);
    isProcessing=false;
  };

  recognition.onend=()=>{isRecording=false};
}

async function processText(text){
  const typingRow=document.createElement("div");
  typingRow.className="msgRow";
  typingRow.innerHTML='<div class="msg typing">Processing...</div>';
  chat.appendChild(typingRow);

  try{
    const intentRes=await fetch("/api/intent",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({text})
    });

    const intent=await intentRes.json();

    const actionRes=await fetch("/api/action",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(intent)
    });

    // ‚úÖ HANDLE 401 BEFORE JSON
    if(actionRes.status===401){
      const authData=await actionRes.json();
      typingRow.remove();
      addMsg("assistant","üîê Connecting to Gmail...");
      setTimeout(()=>{
        window.location.href=authData.auth_url;
      },1000);
      return;
    }

    const result=await actionRes.json();
    typingRow.remove();

    if(result.emails){
      let html="<b>üì¨ Inbox</b>";
      result.emails.forEach((email,i)=>{
        html+=`
        <div class="emailCard">
          <div class="title">Email ${i+1}</div>
          <div><b>From:</b> ${escapeHtml(email.sender||"")}</div>
          <div><b>Subject:</b> ${escapeHtml(email.subject||"")}</div>
          <div><b>Preview:</b> ${escapeHtml(email.snippet||"")}</div>
        </div>`;
      });
      addMsg("assistant",html,true);
    }
    else if(result.email){
      addMsg("assistant",
`From: ${result.email.sender}
Subject: ${result.email.subject}
Preview: ${result.email.snippet}`);
    }
    else if(result.body){
      addMsg("assistant",result.body);
    }
    else if(result.error){
      addMsg("assistant","‚ùå "+result.error);
    }
    else{
      addMsg("assistant",JSON.stringify(result,null,2));
    }

  }catch(e){
    typingRow.remove();
    addMsg("assistant","‚ùå Something went wrong.");
    console.error(e);
  }
}
</script>
</body>
</html>
